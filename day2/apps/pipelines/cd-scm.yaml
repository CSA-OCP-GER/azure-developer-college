pr: none
trigger:
  branches:
    include:
      - master
  paths:
    include:
      - day2/apps/dotnetcore/*
      - day2/apps/infrastructure/templates/scm-api-dotnetcore.json
      - day2/apps/pipelines/cd-scm.yaml

variables:
  configuration: release
  azureSubscription: ANMOCK-InternalSubscription

stages:
  - stage: Build
    displayName: Build

    jobs:
      - job: Build
        displayName: Build Scm Api
        pool:
          vmImage: ubuntu-latest
        steps:
          - template: ../dotnetcore/build/scm-api.yaml
            parameters:
              buildConfiguration: '$(configuration)'
          - task: CopyFiles@2
            inputs:
              sourceFolder: day2/apps/infrastructure/templates
              contents: |
                scm-api-dotnetcore.json
              targetFolder: $(Build.ArtifactStagingDirectory)
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifactName: drop

  - stage: Development
    displayName: Deploy Scm to Development Stage
    dependsOn: Build

    jobs:
      - deployment: Deploy
        displayName: Deploy Scm Api
        variables: 
          - template: variables/cd-scm-dev.yaml
        pool:
          vmImage: ${{ variables.vmImage }}
        environment: Day2-Development
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureResourceGroupDeployment@2
                  inputs:
                    azureSubscription: $(azureSubscription)
                    action: 'Create Or Update Resource Group'
                    resourceGroupName: ${{ variables.resourceGroupName }}
                    location: ${{ variables.location }}
                    templateLocation: 'Linked artifact'
                    csmFile: $(Pipeline.Workspace)/drop/scm-api-dotnetcore.json
                    overrideParameters: -sku ${{ variables.appServicePlanSKU }} -webAppName ${{ variables.apiAppName }}
                - task: AzureWebApp@1
                  inputs:
                    appName: ${{ variables.apiAppName }}
                    azureSubscription: $(azureSubscription)
                    package: $(Pipeline.Workspace)/drop/Adc.Scm.Api.zip

